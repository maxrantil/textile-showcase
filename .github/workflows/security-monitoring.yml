name: Security Monitoring

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual runs
  push:
    branches:
      - master # Run after deployments to track security status

jobs:
  security-audit:
    runs-on: ubuntu-latest
    continue-on-error: true # Make the entire job non-blocking
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run comprehensive security audit
        id: audit
        continue-on-error: true
        run: |
          echo "ðŸ” Running comprehensive security audit..."
          echo "================================================"

          # Run npm audit and capture output
          npm audit --json > audit-report.json || true

          # Extract key metrics
          echo "ðŸ“Š Security Audit Summary:"
          echo "=========================="

          # Count vulnerabilities by severity
          npm audit 2>/dev/null | grep -E "found|Low|Moderate|High|Critical" || true

          echo ""
          echo "ðŸ“ Detailed vulnerability breakdown:"
          npm audit --audit-level low || true

      - name: Check for available fixes
        continue-on-error: true
        run: |
          echo "ðŸ”§ Checking for available fixes..."
          echo "==================================="

          # Check if automatic fixes are available
          if npm audit fix --dry-run 2>&1 | grep -q "fixed"; then
            echo "âœ… Automatic fixes available via 'npm audit fix'"
            echo "Run 'npm audit fix' to apply non-breaking security updates"
          else
            echo "âš ï¸ No automatic fixes available"
            echo "Manual intervention required for breaking changes"
          fi

      - name: Generate security report
        if: always()
        run: |
          echo "ðŸ“„ Generating security report..."

          cat > security-report.md << 'EOF'
          # Security Audit Report

          **Date**: $(date)
          **Branch**: master
          **Action**: Scheduled security monitoring

          ## Summary

          This report tracks security vulnerabilities in project dependencies.

          ### Known Issues (Upstream)

          These vulnerabilities are in upstream dependencies and cannot be directly fixed:

          1. **min-document** - Prototype pollution (Sanity dependency)
          2. **Next.js 15.x** - Various moderate vulnerabilities
          3. **tar-fs** - Symlink validation bypass

          ### Tracking

          All security issues are tracked in [Issue #45](https://github.com/maxrantil/textile-showcase/issues/45)

          ### Recommendations

          1. Monitor upstream projects for fixes
          2. Apply non-breaking updates when available via `npm audit fix`
          3. Evaluate risk vs. functionality for breaking changes
          4. Consider alternative packages if vulnerabilities persist

          ---

          *Generated automatically by GitHub Actions*
          EOF

          echo "âœ… Security report generated: security-report.md"

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-report-${{ github.run_number }}
          path: |
            audit-report.json
            security-report.md
          retention-days: 30

      - name: Update Issue #45 (if vulnerabilities found)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = 45;
            const today = new Date().toISOString().split('T')[0];

            // Add comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ðŸ” Weekly Security Scan - ${today}\n\n` +
                    `Security vulnerabilities detected in dependencies.\n\n` +
                    `**Action Run**: [View Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                    `### Next Steps:\n` +
                    `1. Review the [security report artifact](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n` +
                    `2. Run \`npm audit fix\` locally to apply non-breaking fixes\n` +
                    `3. Evaluate breaking changes for critical vulnerabilities\n\n` +
                    `*This is an automated security monitoring update.*`
            });

            console.log(`âœ… Updated Issue #${issueNumber} with security status`);
