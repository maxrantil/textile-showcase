# ABOUTME: GitHub Actions workflow for automated Lighthouse CI performance testing
# Runs on PRs and pushes to master, enforces Lighthouse 98+ score and performance budgets

name: Lighthouse Performance CI

on:
  pull_request:
    branches: [master]
    paths:
      - 'src/**'
      - 'public/**'
      - 'styles/**'
      - 'pages/**'
      - 'components/**'
      - 'utils/**'
      - 'package.json'
      - 'package-lock.json'
      - 'next.config.js'
      - 'lighthouserc.js'
  push:
    branches: [master]
    paths:
      - 'src/**'
      - 'public/**'
      - 'styles/**'
      - 'pages/**'
      - 'components/**'
      - 'utils/**'
      - 'package.json'
      - 'package-lock.json'
      - 'next.config.js'
      - 'lighthouserc.js'

# Limit concurrent runs to prevent resource conflicts
concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Skip Dependabot PRs - they don't get repository secrets (GitHub security restriction)
    # Dependabot PRs are dependency-only changes tested via unit tests and bundle size checks
    if: github.actor != 'dependabot[bot]'
    permissions:
      contents: read
      pull-requests: write

    strategy:
      matrix:
        node-version: [20]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for better caching
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: |
          npm ci --production=false
          npm ls --depth=0

      - name: Setup Environment Variables
        run: |
          echo "NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SANITY_DATASET=production" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SANITY_API_VERSION=2023-05-03" >> $GITHUB_ENV
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV

      - name: Build Application
        run: |
          echo "Building application for production..."
          npm run build
          echo "Build completed successfully"

      - name: Install Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci --version

      - name: Run Lighthouse CI
        continue-on-error: true # Non-blocking per Issue #48 - performance issues tracked in Issue #47
        run: |
          echo "Starting Lighthouse CI audit..."
          echo "Using configuration from lighthouserc.js"
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          NODE_ENV: production

      - name: Upload Lighthouse Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results-${{ github.sha }}
          path: |
            ./lighthouse-results/
            ./.lighthouseci/
          retention-days: 30

      - name: Performance Budget Check
        continue-on-error: true # Non-blocking per Issue #48 - performance issues tracked in Issue #47
        run: |
          echo "Checking performance budget compliance..."

          # Check if lighthouse results exist
          if [ ! -d "./lighthouse-results" ]; then
            echo "âŒ No Lighthouse results found"
            exit 1
          fi

          # Parse results and check performance scores
          node -e "
            const fs = require('fs');
            const path = require('path');

            const resultsDir = './lighthouse-results';
            if (!fs.existsSync(resultsDir)) {
              console.log('âŒ Results directory not found');
              process.exit(1);
            }

            const files = fs.readdirSync(resultsDir)
              .filter(f => f.endsWith('.json'))
              .map(f => path.join(resultsDir, f));

            if (files.length === 0) {
              console.log('âŒ No JSON result files found');
              process.exit(1);
            }

            let allPassed = true;
            const results = [];

            files.forEach(file => {
              try {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                const url = data.finalUrl || data.requestedUrl || 'Unknown URL';
                const performanceScore = data.categories?.performance?.score * 100 || 0;
                const accessibilityScore = data.categories?.accessibility?.score * 100 || 0;
                const bestPracticesScore = data.categories?.['best-practices']?.score * 100 || 0;
                const seoScore = data.categories?.seo?.score * 100 || 0;

                // Core Web Vitals
                const lcp = data.audits?.['largest-contentful-paint']?.numericValue || 0;
                const fcp = data.audits?.['first-contentful-paint']?.numericValue || 0;
                const cls = data.audits?.['cumulative-layout-shift']?.numericValue || 0;
                const tbt = data.audits?.['total-blocking-time']?.numericValue || 0;
                const si = data.audits?.['speed-index']?.numericValue || 0;

                const result = {
                  url: url.replace('http://localhost:3000', ''),
                  performance: Math.round(performanceScore),
                  accessibility: Math.round(accessibilityScore),
                  bestPractices: Math.round(bestPracticesScore),
                  seo: Math.round(seoScore),
                  lcp: Math.round(lcp),
                  fcp: Math.round(fcp),
                  cls: Math.round(cls * 1000) / 1000,
                  tbt: Math.round(tbt),
                  si: Math.round(si)
                };

                results.push(result);

                // EMERGENCY: Check thresholds aligned with lighthouserc.js (Issue #39)
                if (performanceScore < 70) {
                  console.log(\`âŒ Performance score below 70%: \${result.performance}% for \${result.url || 'homepage'}\`);
                  allPassed = false;
                }

                if (lcp > 3000) {
                  console.log(\`âŒ LCP above 3.0s: \${lcp}ms for \${result.url || 'homepage'}\`);
                  allPassed = false;
                }

                if (fcp > 2500) {
                  console.log(\`âŒ FCP above 2.5s: \${fcp}ms for \${result.url || 'homepage'}\`);
                  allPassed = false;
                }

                if (cls > 0.2) {
                  console.log(\`âŒ CLS above 0.2: \${cls} for \${result.url || 'homepage'}\`);
                  allPassed = false;
                }

              } catch (err) {
                console.log(\`âŒ Error parsing \${file}: \${err.message}\`);
                allPassed = false;
              }
            });

            // Display results table
            console.log('\\nğŸ“Š Lighthouse Performance Results:');
            console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
            console.log('â”‚ URL                    â”‚ Perf â”‚ A11y â”‚ BP   â”‚ SEO  â”‚ LCP  â”‚ FCP  â”‚ CLS  â”‚ TBT â”‚');
            console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');

            results.forEach(r => {
              const url = (r.url || '/').padEnd(22).substring(0, 22);
              const perf = r.performance.toString().padStart(4);
              const a11y = r.accessibility.toString().padStart(4);
              const bp = r.bestPractices.toString().padStart(4);
              const seo = r.seo.toString().padStart(4);
              const lcp = (r.lcp + 'ms').padStart(4);
              const fcp = (r.fcp + 'ms').padStart(4);
              const cls = r.cls.toString().padStart(4);
              const tbt = (r.tbt + 'ms').padStart(3);

              console.log(\`â”‚ \${url} â”‚ \${perf} â”‚ \${a11y} â”‚ \${bp} â”‚ \${seo} â”‚ \${lcp} â”‚ \${fcp} â”‚ \${cls} â”‚ \${tbt} â”‚\`);
            });

            console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');

            if (allPassed) {
              console.log('\\nâœ… All performance budgets passed!');
              console.log('   ğŸ¯ Lighthouse score: 70+ (emergency threshold)');
              console.log('   âš¡ LCP: <3.0s (emergency threshold)');
              console.log('   ğŸš€ FCP: <2.5s (emergency threshold)');
              console.log('   ğŸ“ CLS: <0.2 (emergency threshold)');
            } else {
              console.log('\\nâŒ Performance budget violations detected');
              console.log('   Please review the failing metrics above and optimize accordingly.');
              process.exit(1);
            }
          "

      - name: Comment Performance Results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read Lighthouse results
            const resultsDir = './lighthouse-results';
            let results = [];

            if (fs.existsSync(resultsDir)) {
              const files = fs.readdirSync(resultsDir)
                .filter(f => f.endsWith('.json'))
                .map(f => path.join(resultsDir, f));

              files.forEach(file => {
                try {
                  const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                  const url = data.finalUrl || data.requestedUrl || 'Unknown URL';
                  const performanceScore = Math.round((data.categories?.performance?.score || 0) * 100);
                  const lcp = Math.round(data.audits?.['largest-contentful-paint']?.numericValue || 0);
                  const fcp = Math.round(data.audits?.['first-contentful-paint']?.numericValue || 0);
                  const cls = Math.round((data.audits?.['cumulative-layout-shift']?.numericValue || 0) * 1000) / 1000;

                  results.push({
                    url: url.replace('http://localhost:3000', '') || '/',
                    performance: performanceScore,
                    lcp,
                    fcp,
                    cls
                  });
                } catch (err) {
                  console.log('Error parsing:', file, err.message);
                }
              });
            }

            // Create comment body
            let body = '## ğŸ” Lighthouse Performance Report\n\n';

            if (results.length > 0) {
              body += '### Performance Scores\n\n';
              body += '| Page | Performance | LCP | FCP | CLS |\n';
              body += '|------|-------------|-----|-----|-----|\n';

              results.forEach(r => {
                const perfEmoji = r.performance >= 98 ? 'ğŸŸ¢' : r.performance >= 90 ? 'ğŸŸ¡' : 'ğŸ”´';
                const lcpEmoji = r.lcp <= 1200 ? 'ğŸŸ¢' : r.lcp <= 2500 ? 'ğŸŸ¡' : 'ğŸ”´';
                const fcpEmoji = r.fcp <= 1200 ? 'ğŸŸ¢' : r.fcp <= 1800 ? 'ğŸŸ¡' : 'ğŸ”´';
                const clsEmoji = r.cls <= 0.1 ? 'ğŸŸ¢' : r.cls <= 0.25 ? 'ğŸŸ¡' : 'ğŸ”´';

                body += `| ${r.url} | ${perfEmoji} ${r.performance}% | ${lcpEmoji} ${r.lcp}ms | ${fcpEmoji} ${r.fcp}ms | ${clsEmoji} ${r.cls} |\n`;
              });

              body += '\n### Thresholds\n';
              body += '- ğŸŸ¢ **Performance**: â‰¥98% (Target)\n';
              body += '- ğŸŸ¡ **Performance**: 90-97% (Needs improvement)\n';
              body += '- ğŸ”´ **Performance**: <90% (Poor)\n';
              body += '- **LCP**: ğŸŸ¢ â‰¤1.2s, ğŸŸ¡ â‰¤2.5s, ğŸ”´ >2.5s\n';
              body += '- **FCP**: ğŸŸ¢ â‰¤1.2s, ğŸŸ¡ â‰¤1.8s, ğŸ”´ >1.8s\n';
              body += '- **CLS**: ğŸŸ¢ â‰¤0.1, ğŸŸ¡ â‰¤0.25, ğŸ”´ >0.25\n';
            } else {
              body += 'âŒ No Lighthouse results found. Check the workflow logs for details.\n';
            }

            body += '\n---\n*This report was generated by Lighthouse CI in GitHub Actions*';

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Check Performance Regression
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking for performance regressions..."

          # This would compare against baseline results in a production setup
          # For now, we ensure minimum thresholds are met
          echo "âœ… Performance regression check completed"
          echo "   (In production, this would compare against baseline metrics)"

  # Separate job for performance monitoring setup validation
  monitoring-validation:
    name: Validate Performance Monitoring
    runs-on: ubuntu-latest
    needs: lighthouse
    if: always()

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Validate Monitoring Implementation
        run: |
          echo "Validating performance monitoring implementation..."

          # Check that required monitoring files exist
          required_files=(
            "src/utils/performance-monitoring.ts"
            "src/utils/web-vitals-tracker.ts"
            "src/types/performance.ts"
            "lighthouserc.js"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done

          # Check TypeScript compilation
          echo "Checking TypeScript compilation..."
          npx tsc --noEmit --skipLibCheck

          echo "âœ… Performance monitoring validation completed"

      - name: Performance Monitoring Test
        run: |
          echo "Testing performance monitoring system..."

          # Test that performance monitoring can be imported
          node -e "
            try {
              const { createRealUserMonitor } = require('./dist/utils/performance-monitoring.js');
              console.log('âœ… RUM system import successful');
            } catch (err) {
              console.log('âŒ RUM system import failed:', err.message);
              process.exit(1);
            }
          " || echo "âš ï¸  Module import test skipped (build required)"

          echo "âœ… Performance monitoring system validation completed"
