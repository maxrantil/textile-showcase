name: Production Deployment

on:
  push:
    branches:
      - master

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test -- --testPathIgnorePatterns="bundle-size|production-config|bundle-debug|e2e|credential-manager|demo-mode|audit-logger|api-security|performance-security|middleware-security"
      - name: Run middleware build validation
        run: npm test -- tests/build/middleware-compilation.test.ts
      - name: Run type checking
        run: npm run type-check

  security-scan:
    runs-on: ubuntu-latest
    continue-on-error: true # Don't block deployment for upstream vulnerabilities
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run security audit
        id: security_audit
        continue-on-error: true
        run: |
          echo "üîç Running security audit (non-blocking)..."
          npm audit --audit-level high || echo "‚ö†Ô∏è Security vulnerabilities detected - tracked in Issue #45"
      - name: Run dependency check
        continue-on-error: true
        run: npx audit-ci --high || echo "‚ö†Ô∏è Dependency issues detected - tracked in Issue #45"
      - name: Comment on security status
        if: failure()
        run: |
          echo "‚ö†Ô∏è Security scan detected vulnerabilities. These are tracked in Issue #45."
          echo "üìù Deployment will continue as these are upstream dependency issues."
          echo "üîó See https://github.com/maxrantil/textile-showcase/issues/45 for tracking"

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Create build environment
        run: |
          cat > .env.local << EOF
          NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET=production
          NEXT_PUBLIC_SANITY_API_VERSION=2023-05-03
          NEXT_PUBLIC_UMAMI_URL=${{ secrets.NEXT_PUBLIC_UMAMI_URL }}
          NEXT_PUBLIC_UMAMI_WEBSITE_ID=${{ secrets.NEXT_PUBLIC_UMAMI_WEBSITE_ID }}
          SECURITY_ENABLED=false
          EOF
      - name: Debug environment variables
        run: |
          echo "üîç Checking environment variables..."
          echo "NEXT_PUBLIC_SANITY_PROJECT_ID: ${NEXT_PUBLIC_SANITY_PROJECT_ID:-'NOT SET'}"
          echo "NEXT_PUBLIC_SANITY_DATASET: ${NEXT_PUBLIC_SANITY_DATASET:-'NOT SET'}"
          echo "NEXT_PUBLIC_SANITY_API_VERSION: ${NEXT_PUBLIC_SANITY_API_VERSION:-'NOT SET'}"
          echo "NEXT_PUBLIC_UMAMI_URL: ${NEXT_PUBLIC_UMAMI_URL:-'NOT SET'}"
          echo "NEXT_PUBLIC_UMAMI_WEBSITE_ID: ${NEXT_PUBLIC_UMAMI_WEBSITE_ID:-'NOT SET'}"
          echo "NODE_ENV: ${NODE_ENV:-'NOT SET'}"
          echo "SECURITY_ENABLED: ${SECURITY_ENABLED:-'NOT SET'}"
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: production
          NEXT_PUBLIC_SANITY_API_VERSION: 2023-05-03
          NEXT_PUBLIC_UMAMI_URL: ${{ secrets.NEXT_PUBLIC_UMAMI_URL }}
          NEXT_PUBLIC_UMAMI_WEBSITE_ID: ${{ secrets.NEXT_PUBLIC_UMAMI_WEBSITE_ID }}
          SECURITY_ENABLED: false
      - name: Build application
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: production
          NEXT_PUBLIC_SANITY_API_VERSION: 2023-05-03
          NEXT_PUBLIC_UMAMI_URL: ${{ secrets.NEXT_PUBLIC_UMAMI_URL }}
          NEXT_PUBLIC_UMAMI_WEBSITE_ID: ${{ secrets.NEXT_PUBLIC_UMAMI_WEBSITE_ID }}
          SECURITY_ENABLED: false
        run: npm run build
      - name: Verify build output
        run: ls -la .next/
      - name: Create production environment file for tests
        run: |
          cat > .env.production << EOF
          NODE_ENV=production
          NEXT_PUBLIC_APP_ENV=production
          SECURITY_LOGGING_ENABLED=true
          SSE_ENDPOINT_URL=https://idaromme.dk/api/security/events
          NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET=production
          NEXT_PUBLIC_SANITY_API_VERSION=2023-05-03
          EOF
      - name: Run bundle size tests
        run: npm test -- --passWithNoTests tests/performance/bundle-size.test.ts tests/performance/bundle-debug.test.ts __tests__/deployment/production-config.test.js
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: .next/
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: [test, security-scan, build]
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Deploy to Vultr Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VULTR_HOST }}
          username: ${{ secrets.VULTR_USERNAME }}
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            echo "üöÄ Starting deployment..."

            # Navigate to project directory
            cd /var/www/idaromme.dk || { echo "‚ùå Project directory not found"; exit 1; }

            # Use Node.js v22 from NVM installation (MUST happen before npm ci)
            echo "üîç Setting up Node.js v22 from NVM..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
            nvm use 22 || nvm use default

            # Verify Node.js version
            echo "üîç Node.js version:"
            node --version
            npm --version

            # Backup current state
            echo "üì¶ Creating backup..."
            cp -r .next .next.backup || echo "‚ö†Ô∏è No previous build to backup"

            # Clear Next.js build cache to prevent stale middleware
            echo "üßπ Clearing Next.js build cache..."
            rm -rf .next

            # Pull latest changes
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/master

            # Create production environment file
            echo "üìù Setting up production environment..."
            cat > .env.local << EOF
            NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
            NEXT_PUBLIC_SANITY_DATASET=production
            NEXT_PUBLIC_SANITY_API_VERSION=2023-05-03
            NEXT_PUBLIC_UMAMI_URL=${{ secrets.NEXT_PUBLIC_UMAMI_URL }}
            NEXT_PUBLIC_UMAMI_WEBSITE_ID=${{ secrets.NEXT_PUBLIC_UMAMI_WEBSITE_ID }}
            SECURITY_ENABLED=false
            EOF

            # Install dependencies with correct Node version
            echo "üì¶ Installing dependencies..."
            npm ci

            # Build application
            echo "üî® Building application..."
            if NODE_ENV=production SKIP_ENV_VALIDATION=true npm run build; then
              echo "‚úÖ Build successful"

              # Restart PM2 (use restart to clear Node module cache)
              echo "üîÑ Restarting application..."
              if pm2 list | grep -q "idaromme-website"; then
                echo "üìã PM2 process exists, restarting..."
                pm2 restart idaromme-website
              else
                echo "üöÄ PM2 process not found, starting new instance..."
                PORT=3001 pm2 start npm --name "idaromme-website" -- start
                pm2 save
              fi

              # Cleanup old backup
              rm -rf .next.backup

              echo "üéâ Deployment completed successfully!"
            else
              echo "‚ùå Build failed, rolling back..."
              rm -rf .next
              mv .next.backup .next 2>/dev/null || echo "‚ö†Ô∏è No backup to restore"
              exit 1
            fi

  production-validation:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      - name: Wait for deployment to stabilize
        run: sleep 30
      - name: Run production smoke tests
        env:
          RUN_PRODUCTION_TESTS: 'true'
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: production
          NEXT_PUBLIC_SANITY_API_VERSION: 2023-05-03
        run: npx playwright test tests/e2e/production-smoke.spec.ts --project="Desktop Chrome"
      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: production-smoke-test-results
          path: test-results/
          retention-days: 7
