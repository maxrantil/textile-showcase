name: Branch Protection

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  block-direct-push:
    name: Block Direct Push to Master
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Check if push is from PR merge
        run: |
          # Allow GitHub's PR merge commits (both merge and squash)
          # Merge commits: "Merge pull request #123..."
          # Squash commits: "commit message (#123)"
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          # Define regex patterns as variables (required for bash [[ =~ ]])
          PR_NUMBER_PATTERN='\(#[0-9]+\)$'
          MERGE_PATTERN='^Merge pull request'

          if [[ "$COMMIT_MSG" =~ $PR_NUMBER_PATTERN ]] || [[ "$COMMIT_MSG" =~ $MERGE_PATTERN ]]; then
            echo "✅ PR merge detected - allowing"
            exit 0
          fi

          echo "❌ ERROR: Direct pushes to master are not allowed!"
          echo "Please create a feature branch and submit a PR:"
          echo ""
          echo "  git checkout -b feat/your-feature-name"
          echo "  git push origin feat/your-feature-name"
          echo "  gh pr create"
          exit 1

  check-commits:
    name: Check Commit Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commits
        run: |
          echo "Checking commits for quality..."

          # Get commits in this PR
          git log origin/master..HEAD --oneline

          # Skip validation if this PR modifies the workflow file itself
          # (to avoid false positives when fixing the check)
          if git diff --name-only origin/master..HEAD | grep -q "\.github/workflows/branch-protection\.yml"; then
            echo "⚠️  This PR modifies the branch protection workflow - skipping commit message validation"
            echo "✅ Allowing workflow modifications"
            exit 0
          fi

          # Check for --no-verify bypasses
          # Use -e to treat pattern as string, not option
          if git log origin/master..HEAD | grep -i -e "--no-verify"; then
            echo "❌ ERROR: Commits indicate hooks were bypassed with --no-verify!"
            echo "Never use --no-verify. All commits must pass pre-commit hooks."
            exit 1
          fi

          # Check for co-author or generated-with markers (per CLAUDE.md)
          if git log origin/master..HEAD | grep -i -e "Co-authored-by:" -e "Generated with"; then
            echo "❌ ERROR: Commits contain attribution markers!"
            echo "Per CLAUDE.md: NEVER include co-author or tool attribution in commits"
            exit 1
          fi

          echo "✅ Commits look good"
