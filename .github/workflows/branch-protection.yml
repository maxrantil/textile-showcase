name: Branch Protection

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  block-direct-push:
    name: Block Direct Push to Master
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Check if push is from PR merge
        run: |
          # Allow GitHub's automatic PR merge commits
          if [[ "${{ github.event.head_commit.message }}" =~ ^Merge\ pull\ request ]]; then
            echo "✅ PR merge detected - allowing"
            exit 0
          fi

          echo "❌ ERROR: Direct pushes to master are not allowed!"
          echo "Please create a feature branch and submit a PR:"
          echo ""
          echo "  git checkout -b feat/your-feature-name"
          echo "  git push origin feat/your-feature-name"
          echo "  gh pr create"
          exit 1

  validate-branch-name:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check branch naming convention
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Validating branch name: $BRANCH"

          if [[ "$BRANCH" =~ ^(feat|fix|chore|docs|hotfix|refactor)\/[a-z0-9\-]+$ ]]; then
            echo "✅ Branch name follows convention"
            exit 0
          fi

          echo "❌ ERROR: Invalid branch name format!"
          echo "Branch name must follow: <type>/<description>"
          echo ""
          echo "Valid types: feat, fix, chore, docs, hotfix, refactor"
          echo "Example: feat/add-login-page"
          echo ""
          echo "Current branch: $BRANCH"
          exit 1

  require-tests:
    name: Require Tests Pass
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        env:
          CI: true

  require-build:
    name: Require Build Success
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

  check-commits:
    name: Check Commit Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commits
        run: |
          echo "Checking commits for quality..."

          # Get commits in this PR
          git log origin/master..HEAD --oneline

          # Check for --no-verify bypasses in commit messages
          if git log origin/master..HEAD --grep="--no-verify" --grep="skip.*hook" -i; then
            echo "❌ ERROR: Commits indicate hooks were bypassed!"
            echo "Never use --no-verify. All commits must pass pre-commit hooks."
            exit 1
          fi

          # Check for co-author or generated-with markers (per CLAUDE.md)
          if git log origin/master..HEAD --grep="Co-authored-by:" --grep="Generated with" -i; then
            echo "❌ ERROR: Commits contain attribution markers!"
            echo "Per CLAUDE.md: NEVER include co-author or tool attribution in commits"
            exit 1
          fi

          echo "✅ Commits look good"

  pr-size-check:
    name: Check PR Size
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/master...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/master...HEAD | tail -1 | grep -oP '\d+(?= insertion)|\d+(?= deletion)' | awk '{s+=$1} END {print s}')

          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"

          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "⚠️  WARNING: Large PR detected ($FILES_CHANGED files)"
            echo "Consider breaking into smaller PRs for easier review"
          fi

          if [ "$LINES_CHANGED" -gt 1000 ]; then
            echo "⚠️  WARNING: Large PR detected ($LINES_CHANGED lines)"
            echo "Consider breaking into smaller PRs for easier review"
          fi

          # Don't fail, just warn
          exit 0
